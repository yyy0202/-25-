# 2025年夏季《移动软件开发》实验报告



<center>姓名：闫枳冰  学号：23020007139</center>

| 姓名和学号         | 闫枳冰，23020007139                  |
| -------------------- | -------------------------------- |
| 本实验属于哪门课程？ | 中国海洋大学25夏《移动软件开发》 |
| 实验名称？           | 实验1：第一个微信小程序          |
| 博客地址？           |        https://blog.csdn.net/yyyyyyy0202/article/details/150843719?spm=1001.2014.3001.5502            |
| Github仓库地址？     |                  |



## **一、实验目标**

1. 掌握服务器域名
配置和临时服务器部署；
2. 掌握 wx.request 接口的用法。



## 二、实验步骤
### 2.1 准备工作
1. API密钥申请。在和风天气的网址中选择免费用户类型，用邮箱注册激活，然后查看账户信息，登陆后在控制台先创建项目，再创建凭据，选择认证方式为API，查看并记录个人认证的key。如图。
<img src="https://i-blog.csdnimg.cn/direct/9f1bb4619d404fa696415d6fcdbb740b.png" width="40%">  
API KEY为83fe79946a964951a7cdac9151de5d6a。
2. API调用方法。  
由实验手册和和风天气官方文档，可以知道weather接口现在有locaton一个必填参数和lang、unit两个可选参数。    
<img src="https://i-blog.csdnimg.cn/direct/5de2a2740f6d49faa221af74bd17c715.png" width="40%">  
接口调用的常见语法格式为` https://API HOST/v7/weather/now?[parameters]` 其中[parameters]需要换成使用的参数，用&隔开。其中Location ID是城市、地区或POI点的ID，一般由数字或字母+数字组成，是一个地点的唯一标识。LocationID可以通过定位搜索服务获取。如图。API Host在开发者信息中查看为mf4jaafy4d.re.qweatherapi.com。  
将地址`https://mf4jaafy4d.re.qweatherapi.com/v7/weather/now?location=101010100&key=83fe79946a964951a7cdac9151de5d6a`输入浏览器进行测试。  
如图测试成功。  
<img src="https://i-blog.csdnimg.cn/direct/790c553208cf4a06af701dd4512144f0.png" width="40%">  
返回数据具体为<img src="https://i-blog.csdnimg.cn/direct/73ef23b1845e40f5b6f8bec87c30ea09.png" width="40%">  
<img src="https://i-blog.csdnimg.cn/direct/44aad416d3ed43339ff17e538b0f33be.png" width="40%">  
具体含义可在官方文档查看。    
1. 服务器域名配置。登录mp.weixin.qq.com进入管理员后台后在服务器域名中添加域名。如图。  
<img src="https://i-blog.csdnimg.cn/direct/3c3594d3501c40b1844fa79f89a1508c.png" width="40%">   
### 2.2 项目创建
创建空白项目miniprogram-2。
### 2.3 页面配置
1. 创建页面文件和删除修改文件，和实验一一样，具体不再赘述。
2. 创建自定义文件用来存放天气图表，然后将老师发的图片存入images文件夹中。
<img src="https://i-blog.csdnimg.cn/direct/f72bf8156aa24b87a7656f48b81aace1.png" width="20%">
### 2.4 视图设计
1. 导航栏设计。在app.json中自定义导航栏标题和背景颜色。更改后代码如图。<img src="https://i-blog.csdnimg.cn/direct/f1ae840f1cd5401a998af730db2e6f91.png" width=40%>  
效果如图所示。  
<img src="https://i-blog.csdnimg.cn/direct/a8da1e8d75ab49aa8c3474e0256adad0.png" width=40%>
1. 页面设计。  
 整体页面使用< view >组件，定义class='container';区域1用< picker >组件用来做地区选择器；区域2用< text>组件显示当前城市的温度和天气状态的文字说明;区域3用< image>组件显示天气图标;区域4用< view>组件,并定义class='detail';区域4其中有单元行:4个< view>组件,并定义class='bar'和单元格:每行3个< view>组件,并定义class='box'。
* 整体容器设计。
在index.wxml中定义页面容器< view >。代码如下。

```javascript
<view class='container'>
</view>
```
在app.wxss中设置容器样式。

```javascript
/**app.wxss**/
.container {
  height: 100vh;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: space-around;
} 
```
* 区域1：地区选择器
用< picker>组件实现地区选择器。现在index.wxml代码如下。

```javascript
<view class='container'>
  <!-- 区域1：地区选择器 -->
  <picker mode='region'>
    <view>北京市</view>
  </picker>
</view>
```
* 区域2：文本
需要使用< text >组件实现单行天气信息，包括当前城市温度和天气状况。所以在index.wxml中加入` <text>19摄氏度 晴</text>`。
在wxss中加入文本样式设置。

```javascript
text{
  font-size:80rpx;
  color:#3C5F81;
}
```
* 区域3：图标
在index.wxml中添加` <image src="/images/images/999.png"></image>`
在wxss中添加图表样式的代码`image{width:220rpx;}`
* 区域4：多行天气信息
在wxml中添加

```javascript
<!-- 区域4：多行天气信息 -->
<view class='detail'>
  <view class='bar'>
    <view class='box'>湿度</view>
    <view class='box'>气压</view>
    <view class='box'>能见度</view>
  </view>
  <view class='bar'>
    <view class="box">0%</view>
      <view class="box">0 hPa</view>
    <view class='box'>0 km</view>
  </view>
  <view class='bar'>
    <view class='box'>风向</view>
    <view class='box'>风速</view>
    <view class='box'>风力</view>
  </view>
  <view class='bar'>
    <view class="box">0</view>
      <view class="box">0 Km/h</view>
      <view class="box">0 级</view>
  </view>
  </view>
```
在wxss中添加相关的样式设计

```javascript
.detail{
  width:100%;
  display:flex;
  flex-direction:column;
}
.bar{
  display:flex;
  flex-direction:row;
  margin:20rpx 0;
}
.box{
  width:33.3%;
  text-align:center;
}
```
分别为整体的样式、每一行的样式、每一格的样式。

* 显示效果如图。  
<img src='https://i-blog.csdnimg.cn/direct/7fb3bdf257bc4829a77fbc3114612fb0.png' width=40%>

### 2.5 逻辑实现
1. 更新省、市、区的信息。
需要将wxml中的北京市修改为{{ region }}，然后追加自定义事件。  
代码修改为 

```javascript
 <picker mode="region" bindchange="regionChange">
    <view>{{region}}</view>
  </picker>
```
* ` bindchange="regionChange"：`
是picker的 “变更事件”，当用户在选择器中修改省 / 市 / 区时，会触发 regionChange 函数。 
* region 是js文件中 data 里定义的变量，初始值或选择后的值会渲染到这里。
在js文件中添加代码。

```javascript
Page({
  // 页面的初始数据
  data: {
    region: ['安徽省', '芜湖市', '镜湖区']
  },

  // 更新省、市、区信息的事件处理函数
  regionChange: function(e) {
    this.setData({region: e.detail.value});
  }
})
```
* `data: { region: [...] }`是
页面的初始数据，region 是一个数组，存储默认选中的省市区。
* `regionChange: function(e) { ... }`对应 WXML 中 bindchange 的事件处理函数，其中e 是事件对象，e.detail.value 存储用户新选择的省市区数组，格式和 data.region 一致；
* `this.setData({region: ...})`用来更新 data.region 的值，同时触发页面重新渲染，让 WXML 中 {{region}} 显示最新选择。
2. 获取实况天气数据。
在js文件中添加自定义函数getWeather来获取天气数据。

```javascript
getWeater: function(){
  var that=this;
  wx.request({
    url: 'https://mf4jaafy4d.re.qweatherapi.com/geo/v2/city/lookup',
    data:{
      location:that.data.region[1],
      key:'83fe79946a964951a7cdac9151de5d6a'
    },
    success:function(res){
      console.log(res.data)
      that.setData({
        Place_ID:res.data.location[0].id
      })
      wx.request({
        url:'https://mf4jaafy4d.re.qweatherapi.com/v7/weather/now?',
        data:{
          location:that.data.Place_ID,
          key:'83fe79946a964951a7cdac9151de5d6a'
        },
        success:function(res){
          console.log(res.data.now)
          that.setData({
            now:res.data.now
          })
        }
      })
    }
  })
},
```
* 首先`var that = this` 是为了在嵌套的 API 回调函数中访问当前页面的页面实例。因为在 wx.request 的回调函数中，this 的指向会改变，无法直接使用 this.setData 等方法，所以用that暂存当前页面的this。
* 第一层的wx.request是微信小程序提供的网络请求 API，用于调用和风天气；url是请求的接口地址，调用城市搜索接口；data是请求参数，表示查询城市名，从页面数据 region 的第二项获取，因为region 是一个包含省、市、区的数组，如 ["广东省", "深圳市", "南山区"]，所以region[1] 是城市名。
* 第一层请求的success回调处理城市 ID。

```javascript
success: function(res) {
  console.log(res.data) // 打印接口返回的城市信息
  that.setData({
    Place_ID: res.data.location[0].id
  })
```
`that.setData({ Place_ID: ... })`：将接口返回的第一个城市的 id（res.data.location[0].id）保存到页面数据 Place_ID 中，之后获取天气使用。
* 第二层wx.request：获取实时天气。解释和第一层wx.request差不多。
* 第二层请求的success回调处理天气数据。
`that.setData({  now: res.data.now })`将实时天气数据保存到页面数据 now 中，之后可以在 WXML 中通过 {{now.temp}} 等方式展示。
3. 更新页面信息。
将wxml页面上所有的临时数据替换成{{now，属性}}形式，然后再js的now文件中规定初始数据。
完成后js代码为

```javascript
// index.js
Page({
  data: {
    region:['北京市','北京市','东城区'],
    now:{
      temp:0,
      icon:999,
      cond_txt:'未知',
      cond_code:'999',
      humidity:0,
      pressure:0,
      vis:0,
      windDir:0,
      windSpeed:0,
      windScale:0
    }
  },
  changeRegion:function(e){
    this.setData({
      region:e.detail.value
    })
    this.getWeater();
  },
getWeater: function(){
  var that=this;//this不可以直接在wxAPI中使用
  wx.request({
    url: 'https://mf4jaafy4d.re.qweatherapi.com/geo/v2/city/lookup',
    data:{
      location:that.data.region[1],
      key:'83fe79946a964951a7cdac9151de5d6a'
    },
    success:function(res){
      console.log(res.data)
      that.setData({
        Place_ID:res.data.location[0].id
      })
      wx.request({
        url:'https://mf4jaafy4d.re.qweatherapi.com/v7/weather/now?',
        data:{
          location:that.data.Place_ID,
          key:'83fe79946a964951a7cdac9151de5d6a'
        },
        success:function(res){
          console.log(res.data.now)
          that.setData({
            now:res.data.now
          })
        }
      })
    }
  })
},
})
```
wxml代码为：

```javascript
<view class='container'>
<!-- 区域1：地区选择器 -->
<picker mode='region' bindchange='changeRegion'>
  <view style='font-size:50rpx'>{{region}}</view>
</picker>
<!-- 区域2：文本区域 -->
<text>{{now.temp}}℃{{now.txt}}</text>
<!-- 区域3：图片区域 -->
<image src="/images/{{now.icon}}.png"></image>
<!-- 区域4：多行天气信息 -->
<view class='detail'>
  <view class='bar'>
    <view class='box'>湿度</view>
    <view class='box'>气压</view>
    <view class='box'>能见度</view>
  </view>
  <view class='bar'>
    <view class="box">{{now.humidity}}%</view>
      <view class="box">{{now.pressure}}hPa</view>
    <view class='box'>{{now.vis}}</view>
  </view>
  <view class='bar'>
    <view class='box'>风向</view>
    <view class='box'>风速</view>
    <view class='box'>风力</view>
  </view>
  <view class='bar'>
    <view class="box">{{now.windDir}}</view>
      <view class="box">{{now.windSpeed}} Km/h</view>
      <view class="box">{{now.windScale}} 级</view>

  </view>
</view>
</view>
```
## 三、程序运行结果
结果如图。  
初始情况：  
<img src='https://i-blog.csdnimg.cn/direct/1f61600b739c45c9917e67e89c5ef05b.png' width=20%>  
更改城市名后：  
<img src='https://i-blog.csdnimg.cn/direct/11ba787191d44b0e938b2c762e6da239.png' width=20%>

## 四、问题总结与体会
1. 开始的时候不管怎么选择城市，数据都不改变，报错说request中没有对应的合法域名，但是已经加上了。然后检查了一下发现APPID填的不是同一个。
2. 不太理解刚开始查城市id然后查城市的天气情况，两个网址搞反了，导致出错，数据不发生改变。然后看了实验文档，理解了一下代码，才知道了第一个API用来获取城市id，获取成功后通过id通过第二个API上传到和风天气服务器获取当前 id 城市的天气状况。
3. 通过此次学习，我对制作小程序的过程有了更深刻的理解，要先对页面进行设计，然后再更改进行逻辑实现。
4. 也学会了服务器域名配置和临时服务器部署和wx.request 接口的用法。