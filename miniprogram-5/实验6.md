# 2025年夏季《移动软件开发》实验报告



<center>姓名：闫枳冰  学号：23020007139</center>

| 姓名和学号         | 闫枳冰，23020007139                  |
| -------------------- | -------------------------------- |
| 本实验属于哪门课程？ | 中国海洋大学25夏《移动软件开发》 |
| 实验名称？           | 实验6：推箱子游戏          |
| 博客地址？           |             https://blog.csdn.net/yyyyyyy0202/article/details/151323746?spm=1001.2014.3001.5502       |
| Github仓库地址？     |                  |
[图片下载链接](https://gaopursuit.oss-cn-beijing.aliyuncs.com/course/mobileDev/boxgame_images.zip)


## **一、实验目标**
1. 综合应用所学的知识创建完整的推箱子游戏；
2. 熟练掌握< canvas>和绘图API。 



## 二、实验步骤
### 2.1 需求分析
1. 首页功能需求。首页要有标题和关卡列表；关卡有4个关卡选项，每个关卡显示预览图片和第几关；点击关卡可以打开对应游戏画面。
2. 游戏页功能需求。显示第几关、游戏画面、方向键和“重新开始”按钮；点击方向键可以使游戏主角自行移动或推动箱子前进；游戏画面由8×8的小方块组成，主要包括地板、围墙，箱子，游戏主角和目的地；点击“重新开始”按钮可以将箱子和游戏主角回归初始位置并重新开始游戏。

### 2.2 项目创建
1. 和前面几个实验创建方法相同，选择不使用模板创建。不再赘述。
2. 将链接中的四个关卡图片导入images文件夹，将5个游戏图标素材导入images中的文件夹icons。
<img src="https://i-blog.csdnimg.cn/direct/142bce3c513540c4a3cdd2bd3c494f35.png" width=60%>

3. 在utils文件夹中创建公共JS文件data.js。
<img src="(https://i-blog.csdnimg.cn/direct/eb7b7083aa1843bcbdbb29b522d9aac5.png">

### 2.3导航栏设计和页面设计
1. 导航栏设计。更改app.json文件，更改后的代码如下。

```css
{
  "pages":[
    "pages/index/index"
  ],
  "window":{
    "backgroundTextStyle":"light",
    "navigationBarBackgroundColor": "#E64340",
    "navigationBarTitleText": "推箱子游戏",
    "navigationBarTextStyle":"black"
  },
  "style": "v2",
  "sitemapLocation": "sitemap.json"
}
```
预览效果如下图。
<img src="https://i-blog.csdnimg.cn/direct/e8fa2b2b3ee7401abc1c5fbaba028c93.png" width=40%>

2. 页面设计。
* 公共样式设计：在app.wxss中设置页面容器和顶端标题的公共样式。代码如下。
```css
.container{
  height:100vh;
  color:#E64340;
  font-weight:bold;
  display:flex;
  flex-direction: column;
  align-items: center;
  justify-content: space-evenly;
}

.title{
  font-size: 18pt;
}

```
* 首页设计：首页包含两部分，即内容和关卡列表。顶端标题使用< view>容器；关卡列表也用< view>容器，内部使用数组循环。index.wxml代码如下：

```css
<view class='container'>
  <text class='title'>游戏选关</text>
  <view class='levelBox'>
  <view class='box'>
    <image src='/images/level01.png'></image>
    <text>第一关</text>
  </view>
  </view>
</view>
```
index.wxss代码如下：

```cpp
.levelBox{
  width:100%;
}

.box{
  width:50%;
  float:left;
  margin:20rpx 0;
  display:flex;
  flex-direction: column;
  align-items: center;
}

image{
  width:300rpx;
  height:300rpx;
}

```
效果如下图：
<img src="https://i-blog.csdnimg.cn/direct/cf76d4a317a045abace4dcebf12c1b17.png" width=80%>  

* 游戏页面设计。
游戏页而需要用户点击首页的关卡列表，然后在新窗口中打开该页面。游戏页面包括游戏关卡标题、游戏画面、方向键和“重新开始”按钮。  
由于暂时没有做点击跳转的逻辑设计，所以可以在开发工具顶端选择“普通编译”下的“添加编译模式”，并携带临时测试参数level=0,如图所示：  
<img src="https://i-blog.csdnimg.cn/direct/23845777dee848b7b069b8acb15d89ce.png" width=80%>  
此时预览就可以直接显示game页面了，设计完毕后再改回“普通编译”模式即可重新显示首页。
整体容器和顶端标题用< view>组件；游戏画布用< canvas>组件；四个方向键和一个重新开始按钮用组件< button>。  
game.wxml代码如下：

```css
<view class='container'>

  <view class='title'>第一关</view>

  <canvas canvas-id='myCanvas'></canvas>

  <view class='btnBox'>
    <button type='warn'>↑</button>
    <view>
      <button type='warn'>←</button>
      <button type='warn'>↓</button>
      <button type='warn'>→</button>
    </view>
  </view>

  <button type='warn'>重新开始</button>
</view>

```
game.wxss代码如下。

```css
canvas{
  border:1rpx solid;
  width:320px;
  height:320px;
}

.btnBox{
  display:flex;
  flex-direction: column;
  align-items: center;
}

.btnBox view{
  display:flex;
  flex-direction:row;
}

.btnBox button{
  width:90rpx;
  height:90rpx;
}

button{
  margin:10rpx;
}

```
效果如下。
<img src="https://i-blog.csdnimg.cn/direct/df48bd4f3aa347018cb97928b1c4a683.png">

3. 逻辑实现
* 公共逻辑
在公共JS文件(utils/data.js)中配置游戏地图的数据，代码如下：

```js
//地图数据napl~map4
//地图数据：1为墙、2为路、3为终点、4为箱子、5为人物、0为墙的外围
//=================================
//关卡1
var mapl =[
[0,1,1,1,1,1,0,0],
[0,1,2,2,1,1,1,0],
[0,1,5,4,2,2,1,0],
[1,1,1,2,1,2,1,1],
[1,3,1,2,1,2,2,1],
[1,3,4,2,2,1,2,1],
[1,3,2,2,2,4,2,1],
[1,1,1,1,1,1,1,1]
]
//关卡2
var map2 =[
[0,0,1,1,1,0,0,0],
[0,0,1,3,1,0,0,0],
[0,0,1,2,1,1,1,1],
[1,1,1,4,2,4,3,1],
[1,3,2,4,5,1,1,1],
[1,1,1,1,4,1,0,0],
[0,0,0,1,3,1,0,0],
[0,0,0,1,1,1,0,0]
]
//关卡3
var map3=[
[0,0,1,1,1,1,0,0],
[0,0,1,3,3,1,0,0],
[0,1,1,2,3,1,1,0],
[0,1,2,2,4,3,1,0],
[1,1,2,2,5,4,1,1],
[1,2,2,1,4,4,2,1],
[1,2,2,2,2,2,2,1],
[1,1,1,1,1,1,1,1]
]
//关卡4
var map4=[
[0,1,1,1,1,1,1,0],
[0,1,3,2,3,3,1,0],
[0,1,3,2,4,3,1,0],
[1,1,1,2,2,4,1,1],
[1,2,4,2,2,4,2,1],
[1,2,1,4,1,1,2,1],
[1,2,2,2,5,2,2,1],
[1,1,1,1,1,1,1,1]
]
```
这里分别使用map1~map4代表4个不同关卡的地图数据，以二维数组的形式存放。当前地图均由8×8的方格组成，每个位置的数字代表对应的图标素材。
当前地图数据和图片素材仅供参考，开发者也可以自行修改游戏布局和图片。
然后需要在data.js中使用module.exports语句暴露数据出口，代码片段如下：

```css
module.exports={
  maps:[map1,map2,map3,map4]
}

```
最后需要在game页面的JS文件顶端引用公共JS文件，代码如下：  

```javascript
var data=require('../../utils/data.js');
```
要注意小程序在这里只能使用相对路径。  
* 首页逻辑。首页有两个功能，一是展示关卡列表。二是点击图片能跳转到游戏页面。  
关卡列表展示需要在JS文件的data中录入关卡图片的信息，相关index.js代码如下：

```js
data: {
    levels:[
      'level01.png',
      'level02.png',
      'level03.png',
      'level04.png'
    ]
  },

```
接着为关卡对应的组件添加wx:for属性循环显示关卡列表数据和图片。
修改后的index.wxml代码如下：

```js
<view class='container'>
  <text class='title'>游戏选关</text>
  <view class='levelBox'>
  <view class='box'wx:for='{{levels}}'wx:key='levels{{index}}'>
    <image src='/images/{{item}}'></image>
    <text>第{{index+1}}关</text>
  </view>
  </view>
</view>

```
页面如下：
<img src="https://i-blog.csdnimg.cn/direct/248ddc39f8e64cc6af03287d3d703f71.png" width=80%>  
 
实现点击关卡图片即可实现跳转，需要首先为关卡列表项目添加点击事件。
index.wxml代码片段修改如下：

```css
 <view class='box'wx:for='{{levels}}'wx:key='levels{{index}}'bindtap='chooseLevel'data-level='{{index}}'>

```
上述代码表示为关卡添加了自定义点击事件函数chooseLevel,并且使用data-level属性携带了关卡图片下标信息。
然后在对应的index.js文件中添加chooseLevel函数的内容，代码片段如下：

```js
chooseLevel:function(e){
    let level=e.currentTarget.dataset.level
    wx:navigateTo({
      url:'../game/game?level='+level
    })
  },


```
此时已经可以点击跳转到game页面，并且成功携带了关卡图片数据，但是仍需在game页面进行携带数据的接收处理才可显示正确的游戏画面。  

* 游戏页逻辑主要有以下几个功能需要实现：显示当前是第几关；游戏地图的绘制;4个方向键可以移动游戏主角；点击“重新开始”按钮可以使游戏地图还原成最初状态。  
显示当前第几关，在游戏页面接收关卡信息，并显示对应的图片内容。game.js代码片段如下：

```js
  data: {
    level:1

  }, 
onLoad:function(options) {
    let level=options.level
    this.setData({
      level:parseInt(level)+1
    })
  },

```
修改WXML(pages/game/game.wxml)代码如下：  

```css
 <view class='title'>第{{level}}关</view>

```
在game.js的顶端记录些游初始数据信息。
对应的JS(pages/game/game.js)代码段添加如下：

```js

//地图图层数据
var map =[
[0,0,0,0,0,0,0,0],
[0,0,0,0,0,0,0,0],
[0,0,0,0,0,0,0,0],
[0,0,0,0,0,0,0,0],
[0,0,0,0,0,0,0,0],
[0,0,0,0,0,0,0,0],
[0,0,0,0,0,0,0,0],
[0,0,0,0,0,0,0,0],
]
//箱子图层数据
var box =[
[0,0,0,0,0,0,0,0],
[0,0,0,0,0,0,0,0],
[0,0,0,0,0,0,0,0],
[0,0,0,0,0,0,0,0],
[0,0,0,0,0,0,0,0],
[0,0,0,0,0,0,0,0],
[0,0,0,0,0,0,0,0],
[0,0,0,0,0,0,0,0]
]
var w=40

var row=0
var col=0

```
然后初始化游戏画面。首先需要根据当前是第几关读取对应的游戏地图信息，并更新到游戏初始数据中。在game.js文件中添加initMap函数，用于初始化游戏地图数据。
对应的game.js代码片段添加如下：

```js
initMap:function(level){
    let mapData=data.maps[level]

    for(var i=0;i<8;i++){
      for(var j=0;j<8;j++){
        box[i][j]=0
        map[i][j]=mapData[i][j]

        if(mapData[i][j]==4){
          box[i][j]=4
          map[i][j]=2
        }else if(mapData[i][j]==5){
          map[i][j]=2
          row=i
          col=j
        }
      }
    }
  },

```
上述代码首先从公共函数文件data.js中读取对应关卡的游戏地图数据，然后使用双重for循环对每一块地图数据进行解析，并更新当前游戏的初始地图数据、箱子数据以及游戏主角（小鸟）的所在位置。然后在game.js中添加自定义函数drawCanvas,用于将地图信息绘制到画布上。
对应的game.js代码片段添加如下：

```css
 drawCanvas:function(){
    let ctx=this.ctx
    ctx.clearRect(0,0,320,320)

    for(var i=0;i<8;i++){
      for(var j=0;j<8;j++){
        let img='ice'
        if(map[i][j]==1){
          img='stone'
        }else if(map[i][j]==3){
          img='pig'
        }

        ctx.drawImage('/images/icons/'+img+'.png',j*w,i*w,w,w)

        if(box[i][j]==4){
          ctx.drawImage('/images/icons/box.png',j*w,i*w,w,w)
        }
      }
    }
    ctx.drawImage('/images/icons/bird.png',col*w,row*w,w,w)

    ctx.draw()
  },


```
最后在game.js的onload函数中创建画布上下文，并依次调用自定义函数initMap和drawCanvas。对应的game.js代码片段添加如下：

```js
onLoad:function(options) {
    let level=options.level
    this.setData({
      level:parseInt(level)+1
    })
    this.ctx=wx.createCanvasContext('myCanvas')

    this.initMap(level)

    this.drawCanvas()
  },

```
效果如下图。  
<img src="https://i-blog.csdnimg.cn/direct/e7a7c920c56d486f9352558ff0488a48.png" width=60%>  

方向键逻辑实现要修改game.wxml页面中的4个方向键button,为其绑定点击事件，game.wxml代码修改后如下：

```js
 <button type='warn'bindtap='up'>↑</button>
    <view>
      <button type='warn'bindyap='left'>←</button>
      <button type='warn'bindtap='down'>↓</button>
      <button type='warn'bindtap='right'>→</button>
    </view>

```
在game,js文件中添加自定义函数up、down,left和right,分别用于实现游戏主角（小鸟）在上、下、左、右4个方向的移动，每次点击在条件允许的情况下移动一格。
对应在game.js代码片段添加如下：

```js
 up:function(){
    if(row>0){
      if(map[row-1][col]!=1&&box[row-1][col]!=4){
        row=row-1
      }
      else if(box[row-1][col]==4){
        if(row-1>0){
          if(map[row-2][col]!=1&&box[row-2][col]!=4){
            box[row-2][col]=4
            box[row-1][col]=0
            row=row-1
          }
        }
      }
      this.drawCanvas()
      this.checkWin()
    }
  },

  down:function(){
    if(row<7){
      if(map[row+1][col]!=1&&box[row+1][col]!=4){
        row=row+1
      }
      else if(box[row+1][col]==4){
        if(row+1<7){
          if(map[row+2][col]!=1&&box[row+2][col]!=4){
            box[row+2][col]=4
            box[row+1][col]=0
            row=row+1
          }
        }
      }
      this.drawCanvas()
      this.checkWin()
    }
  },

  left:function(){
    if(col>0){
      if(map[row][col-1]!=1&&box[row][col-1]!=4){
        col=col-1
      }
      else if(box[row][col-1]==4){
        if(col-1>0){
          if(map[row][col-2]!=1&&box[row][col-2]!=4){
            box[row][col-2]=4
            box[row][col-1]=0
            col=col-1
          }
        }
      }
      this.drawCanvas()
      this.checkWin()
    }
  },

  right:function(){
    if(col<7){
      if(map[row][col+1]!=1&&box[row][col+1]!=4){
        col=col+1
      }
      else if(box[row][col+1]==4){
        if(col+1<7){
          if(map[row][col+2]!=1&&box[row][col+2]!=4){
            box[row][col+2]=4
            box[row][col+1]=0
            col=col+1
          }
        }
      }
      this.drawCanvas()
      this.checkWin()
    }
  },


```
最后判断游戏成功，在game.js文件中添加白定义函数isWin,用于判断游戏是否已经成功。
对应的game.js代码片段添加如下：

```js
isWin:function(){
    for(var i=0;i<8;i++){
      for(var j=0;j<8;j++){
        if(box[i][j]==4&&map[i][j]!=3){
          return false
        }
      }
    }
    return true
  },

```
上述代码的判断逻辑是只要有一个箱子没有在终点位置就判断游戏尚未成功。
然后在game.js中添加白定义函数checkWin,.要求一旦游戏成功就弹出提示对话框。
对应的game.js代码片段修改如下：

```js
checkWin:function(){
    if(this.isWin()){
      wx.showModal({
        title:'恭喜',
        content:'游戏成功',
        showCancel:false
      })
    }
  },
```
最后在game.js的4个方向键函数中追加关于游戏成功判断的函数，这里以up函数为例，对应的JS(pages/game/game.js)代码片段修改如下：

```js
   this.drawCanvas()
      this.checkWin()

```
其他3个方向的函数的修改方式和up函数完全一致。游戏成功后的画面如图所示。

* 重新开始游戏，修改game.wxml代码，为“重新开始”按钮追加自定义函数的点击事件。
game.wxml代码片段修改如下：

```js
 restartGame:function(){
    this.initMap(this.data.level-1)
    this.drawCanvas()
  },

```
效果如下。
<img src="https://i-blog.csdnimg.cn/direct/2501cf2d8ebf43109c7101b7f04e25d1.png" width=60%>

## 三、程序运行结果
如下图。  
<img src="https://i-blog.csdnimg.cn/direct/426b91c05f2e486fb7674155eac92312.png" width=60%>

<img src="https://i-blog.csdnimg.cn/direct/0e2d034006db46328c1262e0eb8dc268.png" width=60%>


<img src="https://i-blog.csdnimg.cn/direct/2501cf2d8ebf43109c7101b7f04e25d1.png" width=60%>


## 四、问题总结与体会
1. 在实验过程中要注意逻辑实现时要考虑到全部情况，不然会报错。
2. 此次实验学习到了组件< canvas>和绘图API的用法，比较复杂，还学会了运用utils存储数据，也巩固了一下之前学的wx:for的用法和页面跳转的方法，受益良多。