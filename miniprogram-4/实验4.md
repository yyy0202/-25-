# 2025年夏季《移动软件开发》实验报告

<center>姓名：闫枳冰  学号：23020007139</center>

| 姓名和学号         |闫枳冰，23020007139                |
| -------------------- | -------------------------------- |
| 本实验属于哪门课程？ | 中国海洋大学25夏《移动软件开发》 |
| 实验名称？           | 实验4：媒体API之口述校史          |
| 博客地址？           |                 |
| Github仓库地址？     |             |



## **一、实验目标**

1. 掌握视频API的操作方法；  
2. 掌握如何发送随机颜色的弹幕。



## 二、实验步骤
### 2.1 项目创建
和之前的实验一样进行创建项目，在此不再赘述。
### 2.2 视图设计
1. 导航栏设计。将所有页面的导航栏标题文本为“口述校史”、背景颜色为金棕色（#987938）。app.json代码如下。

```javascript
{
  "pages": [
    "pages/index/index"
  ],
  "window":{
    "navigationBarBackgroundColor": "#987938",
    "navigationBarTitleText": "口述校史"
  }
}
```
预览效果如下图。<img src="https://i-blog.csdnimg.cn/direct/6206d80faa694f9c8d4ddc6c3fdf208d.png" width=80%>  

2. 页面设计。
页面主要包括3各区域。第一个区域是视频播放器，使用< view >组件；第二个区域是弹幕发送区域，包含文本输入框和发送按钮，用< view >组件，并且定义class='danmuArea'，然后内部是一个< input >和< button >组件；第三个区域是视频列表，单元行内用< view >组件，并且定义class='videoBar'，单元行内每一行用一个< image >组件显示图表和一个< text >组件显示视频标题。
* 区域1-视频组件设计  
在index.wxml中的代码如下。

```javascript
<!--区域1:视频播放器-->
<video id="myVideo" controls></video>
```
其中control属性是用于显示播放/暂停、音量等控制组件。
在index.wxss中代码如下。

```javascript
video {
  width: 100%;
}
```
* 区域2-弹幕区域设计  

在index.wxml中添加代码如下。

```javascript
<!-- 区域2：弹幕控制 -->  
<view class="danmuArea">
  <input type="text" placeholder="请输入弹幕内容"></input>
  <button>发送弹幕</button>
</view>
```
 在index.wxss中添加代码如下

```javascript
/* 区域2：弹幕控制样式 */
/* 2-1 弹幕区域样式 */
.danmuArea {
  display: flex;
  flex-direction: row; 
}

/* 2-2 文本输入框样式 */
input {
  flex-grow: 1; 
  height: 100rpx; 
  background-color: #987938; 
  color: white; 
}

/* 2-3 按钮样式 */
button {
  border: 1rpx solid #987938; 
  background-color: white;
  color: #987938; 
  height: 100rpx;/*高度调整为100rpx，和input组件高度相同*/
}
```
其中`flex-grow:1`表示扩张文本框让他填满整行空间。`border: 1rpx solid #987938`表示按钮有1rpx宽的实线棕色边框。
* 区域3-视频列表

在index.wxml中添加代码如下。

```javascript
<!-- 区域3：视频列表 -->
<view class="videoList">
  <view class="videoBar">
    <image src="/images/play.png"></image>
    <text>这是一个测试标题</text>
  </view>
</view>
```
在index.wxss中添加代码如下。调整一下字体颜色、边距等样式。

```css
/* 区域3：视频列表样式 */
/* 3-1 视频列表区域样式 */
.videoList {
  width: 100%; /* 宽度 */
  min-height: 400rpx; /* 最小高度 */
}

/* 3-2 单行列表区域样式 */
.videoBar {
  width: 95%; 
  display: flex; 
  flex-direction: row; 
  margin: 10rpx; 
  border-bottom: 1rpx solid #987938; 
}

/* 3-3 播放图标样式 */
image {
  width: 70rpx; 
  height: 70rpx; 
  margin: 20rpx; 
}

/* 3-4 文本标题样式 */
text {
  font-size: 45rpx; 
  color: #987938; 
  margin: 20rpx; 
  flex-grow: 1; 
}
```

### 2.3 逻辑实现
1. 更新播放列表。    
通过wx:for属性循环展示所有视频列表，代码如下。在index.wxml中修改区域 1 和区域 3：

```javascript
<!-- 区域1：视频播放器 -->
<video id="myVideo" controls src="{{src}}"></video>

<!-- 区域2：弹幕控制区域（代码略） -->

<!-- 区域3：视频列表 -->
<view class="videoList">
  <view class="videoBar" wx:for="{{list}}" wx:key="video{{index}}">
    <image src="/images/play.png"></image>
    <text>{{item.title}}</text>
  </view>
</view>
```
给< video>组件添加`src="{{src}}"`：通过数据绑定关联JS中的src变量，后续j就可以点击视频列表时，可动态更新该变量实现视频切换。给视频列表的`<view class="videoBar">`添加`wx:for="{{list}}"`来遍历 JS 中data的list数组，将数组中的每个视频信息渲染成一行列表；`wx:key="video{{index}}"`用于指定唯一标识,
文本内容从 “这是一个测试标题” 改为{{item.title}}：通过item获取list数组中每个视频的标题，实现动态展示。  
index.js（添加list数组存储视频信息）：


```javascript

Page({
  /**
   * 页面的初始数据
   */
  data: {
    list: [
      {
        id: '299371',
        title: "杨国宜先生口述校史实录",
        videoUrl: 'http://arch.ahnu.edu.cn/__local/6/CB/D1/C2DF3FC847F4CE2ABB67034C595_025F0082_ABD7AE2.mp4?e=.mp4'
      },
      {
        id: '299396',
        title: "唐成伦先生口述校史实录",
        videoUrl: 'http://arch.ahnu.edu.cn/__local/E/31/EB/2F368A265E6C842BB6A63EE5F97_425ABEDD_7167F22.mp4?e=.mp4'
      },
      {
        id: '299378',
        title: "倪光明先生口述校史实录",
        videoUrl: 'http://arch.ahnu.edu.cn/__local/9/DC/3B/35687573BA2145023FDAEBAFE67_AAD8D222_925F3FF.mp4?e=.mp4'
      },
      {
        id: '299392',
        title: "吴兴仪先生口述校史实录",
        videoUrl: 'http://arch.ahnu.edu.cn/__local/5/DA/BD/7A27865731CF2B096E90B522005_A29CB142_6525BCF.mp4?e=.mp4'
      }
    ]
  }
})
```
在data中新增list数组，数组每个元素对应一个视频，包含id、title、videoUrl。  
    
2. 点击播放视频。  
通过data-url存储视频地址、bindtap绑定点击事件，结合视频上下文控制播放，代码如下。
index.wxml（修改区域 3 的videoBar）：
```javascript
<!-- 区域3：视频列表 -->
<view class="videoList">
  <view class="videoBar" wx:for="{{list}}" wx:key="video{{index}}" data-url="{{item.videoUrl}}" bindtap="playVideo">
    <image src="/images/play.png"></image>
    <text>{{item.title}}</text>
  </view>
</view>
```
`data-url="{{item.videoUrl}}"`将当前列表项对应的视频地址存储在data-url属性中，点击时可通过事件对象获取该地址。`bindtap="playVideo"`给列表项绑定点击事件playVideo，点击列表项时触发该函数，执行播放逻辑。  
index.js修改代码如下：

```javascript
Page({
  /**
   * 生命周期函数--监听页面加载
   */
  onLoad: function(options) {
    // 创建视频上下文
    this.videoCtx = wx.createVideoContext('myVideo')
  },

  /**
   * 播放视频
   */
  playVideo: function(e) {
    // 停止之前正在播放的视频
    this.videoCtx.stop()
    // 更新视频地址
    this.setData({
      src: e.currentTarget.dataset.url
    })
    // 播放新的视频
    this.videoCtx.play()
  },

  // 页面初始数据（list数组略）
  data: { /* ... */ }
})
```
先调用`this.videoCtx.stop()`函数停止当前正在播放的视频，避免多个视频同时播放。然后用
`e.currentTarget.dataset.url`通过事件对象e获取列表项的data-url属性值，再用`this.setData`更新data中的src变量，因为video组件的src绑定了该变量，所以此时视频地址会自动更新。然后更新地址后，调用`this.videoCtx.play()`播放方法，播放新视频。  

3. 发送弹幕
* 基础红色弹幕  
开启视频弹幕功能，修改index.wxml的< video>组件和弹幕区域，代码如下。
```javascript
<!-- 区域1：视频播放器（添加弹幕相关属性） -->
<video id="myVideo" src="{{src}}" controls enable-danmu danmu-btn></video>

<!-- 区域2：弹幕控制（添加输入监听和点击事件） -->
<view class="danmuArea">
  <input type="text" placeholder="请输入弹幕内容" bindinput="getDanmu"></input>
  <button bindtap="sendDanmu">发送弹幕</button>
</view>
```
先给< video>组件加上`enable-danmu`允许视频接收弹幕，然后加`danmu-btn`在视频上显示 “发送弹幕” 按钮。然后给< input>加`bindinput="getDanmu"`来监听输入框文本变化，实时将输入内容同步到 JS 的danmuTxt变量中。再< button>加`bindtap="sendDanmu"`绑定发送事件，点击按钮时触发`sendDanmu`函数，发送弹幕。  
修改index.js代码如下。

```javascript
Page({
  /**
   * 页面的初始数据
   */
  data: {
    danmuTxt: "", // 存储弹幕文本
    list: [/* ... */] // 视频列表数组（略）
  },

  /**
   * 更新弹幕内容（获取输入框文本）
   */
  getDanmu: function(e) {
    this.setData({
      danmuTxt: e.detail.value
    })
  },

  /**
   * 发送弹幕（红色）
   */
  sendDanmu: function(e) {
    let text = this.data.danmuTxt;
    this.videoCtx.sendDanmu({
      text: text,
      color: 'red' // 弹幕颜色为红色
    })
  },

  // 视频上下文创建、playVideo函数等（略）
  onLoad: function(options) { /* ... */ },
  playVideo: function(e) { /* ... */ }
})
```
`data`中新增`danmuTxt`来专门存储输入框的文本。然后调用`getDanmu`函数,当输入框文本变化时，通过`e.detail.value`获取当前文本，用`this.setData`更新`danmuTxt`。然后在`sendDanmu`函数中调用`this.videoCtx.sendDanmu()`发送弹幕，参数text为弹幕内容，来自danmuTxt，color固定为红色，实现红色弹幕效果。
* 添加getRandomColor函数生成随机十六进制颜色，修改index.js，index.js全部代码如下。

```javascript
// index.js
Page({
  data: {
      danmuTxt: '',
      list: [{
              id: '1001',
              title: '杨国宜先生口述校史实录',
              videoUrl: 'http://arch.ahnu.edu.cn/__local/6/CB/D1/C2DF3FC847F4CE2ABB67034C595_025F0082_ABD7AE2.mp4?e=.mp4'
          },
          {
              id: '1002',
              title: '唐成伦先生口述校史实录',
              videoUrl: 'http://arch.ahnu.edu.cn/__local/E/31/EB/2F368A265E6C842BB6A63EE5F97_425ABEDD_7167F22.mp4?e=.mp4'
          },
          {
              id: '1003',
              title: '倪光明先生口述校史实录',
              videoUrl: 'http://arch.ahnu.edu.cn/__local/9/DC/3B/35687573BA2145023FDAEBAFE67_AAD8D222_925F3FF.mp4?e=.mp4'
          },
          {
              id: '1004',
              title: '吴仪兴先生口述校史实录',
              videoUrl: 'http://arch.ahnu.edu.cn/__local/5/DA/BD/7A27865731CF2B096E90B522005_A29CB142_6525BCF.mp4?e=.mp4'
          }
      ]
  },
  getDanmu: function (e) {
      this.setData({
          danmuTxt: e.detail.value
      })
  },
  sendDanmu: function (e) {
      let text = this.data.danmuTxt;
      this.videoCtx.sendDanmu({
          text: text,
          color: this.getRandomColor()
      })
  },
  playVideo: function (e) {
      this.videoCtx.stop()
      this.setData({
          src: e.currentTarget.dataset.url
      })
      this.videoCtx.play()
  },
  onLoad: function (options) {
      this.videoCtx = wx.createVideoContext('myVideo')
  },
  getRandomColor: function () {
      let rgb = []
      for (let i = 0; i < 3; ++i) {
          let color = Math.floor(Math.random() * 256).toString(16)
          color = color.length == 1 ? '0' + color : color
          rgb.push(color)
      }
      return '#' + rgb.join('')
  }
})
```
新增`getRandomColor`函数，生成随机十六进制颜色：先定义rgb存储三原色16进制值，然后循环三次，分别生成RGB的值。每次循环先用`Math.random()`生成0-1的小数，*256后取整，得到0-255的随机整数，然后将整数转为16进制（`toString(16)`），若只有1位则补0。然后再将处理后的16进制颜色存入rgb数组。最后拼接成十六进制颜色格式。  


## 三、程序运行结果
如下图所示。  

<img src='https://i-blog.csdnimg.cn/direct/e5702387775345daa8114578f807799b.png' width=40%>
<img src='https://i-blog.csdnimg.cn/direct/0fa77db415d34fe5ab5f2878df24d820.png' width=40%>


## 四、问题总结与体会
1. 在组件上存储自定义数据的时候注意必须用data-的格式命名属性，才能确保同意数据传递入口，js才能通过事件对象如`e.currentTarget.dataset`准确识别和获取自定义数据。不然会出错，没有办法传递数据
2. 此次实验让我学会了调用视频API的操作方法也掌握了如何发送随机颜色的弹幕。对微信小程序的架构有了更深刻的理解，也加深了对设计实现小程序的流程的认识。收获颇大。

